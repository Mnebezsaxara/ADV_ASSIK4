# ADV_ASSIK4

## üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:
- Redis-–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è read-heavy endpoint
- MongoDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–æ–π —á–µ—Ä–µ–∑ Mongo (–∫–æ–ª–ª–µ–∫—Ü–∏–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã)

---

## üì¶ –°–µ—Ä–≤–∏—Å—ã –∏ –ø–æ—Ä—Ç—ã

| –°–µ—Ä–≤–∏—Å             | –ü–æ—Ä—Ç   |
|--------------------|--------|
| user-service       | 50051  |
| inventory-service  | 50052  |
| order-service      | 50053  |
| Redis              | 6379   |
| MongoDB (Replica Set) | 27017 |
| NATS               | 4222   |

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### üîπ Redis Caching
- `user-service`: `GetUserProfile` ‚Äî –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–ª—é—á—É `user:<id>`
- `inventory-service`: `GetProductByID` ‚Äî –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–ª—é—á—É `product:<id>`
- TTL –∫–µ—à–∞ ‚Äî 5 –º–∏–Ω—É—Ç
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–µ—à –º–æ–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å

### üîπ MongoDB Transactions
- `order-service`: `CreateOrder` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
  - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–∫–∞–∑
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ NATS
  - –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –ø–æ–ª–Ω—ã–π rollback

---

## üöÄ –ó–∞–ø—É—Å–∫ MongoDB Replica Set (–ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Docker)

> ‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, `192.168.1.70`) ‚Äî –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ **–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** (Compass, mongosh –∏ —Ç.–¥.)

```bash
docker run -d --name mongo-rs \
  --add-host=host.docker.internal:host-gateway \
  -p 27017:27017 \
  mongo --replSet rs0 --bind_ip_all


–ó–∞—Ç–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:

docker exec -it mongo-rs mongosh

> rs.initiate()
> cfg = rs.conf()
> cfg.members[0].host = "192.168.1.70:27017"  # ‚ö†Ô∏è –£–∫–∞–∑–∞—Ç—å –≤–∞—à IP –∏–∑ `ipconfig`
> rs.reconfig(cfg, { force: true })
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

> rs.status()  # –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å stateStr: "PRIMARY"


üß™ –¢–µ—Å—Ç—ã (—á–µ—Ä–µ–∑ BloomRPC)
1Ô∏è‚É£ user-service ‚Üí GetUserProfile
{
  "id": "64f8f8e2a1b2c933a9c12345"
}
‚úÖ –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: "–û—Ç–¥–∞–Ω–æ –∏–∑ Mongo –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–æ"
üîÅ –ü–æ–≤—Ç–æ—Ä: "–û—Ç–¥–∞–Ω–æ –∏–∑ Redis –∫–µ—à–∞"

2Ô∏è‚É£ inventory-service ‚Üí GetProductByID
{
  "id": "67f2a30cb9e23361a8b71238"
}
‚úÖ –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: "–û—Ç–¥–∞–Ω–æ –∏–∑ Mongo –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–æ"
üîÅ –ü–æ–≤—Ç–æ—Ä: "–û—Ç–¥–∞–Ω–æ –∏–∑ Redis –∫–µ—à–∞"

3Ô∏è‚É£ order-service ‚Üí CreateOrder
{
  "user_id": "6828a457b06e9a781c49fc58",
  "products": [
    {
      "product_id": "67f2a30cb9e23361a8b71238",
      "quantity": 2
    }
  ]
}

üì§ –í –ª–æ–≥–∞—Ö order-service:
–°–æ–±—ã—Ç–∏–µ 'order.created' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ NATS
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

üìâ –í –ª–æ–≥–∞—Ö inventory-service:
Stock is reduced: 67f2a30cb9e23361a8b71238 : -2

üìé –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
–í—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ø–æ –∞–¥—Ä–µ—Å—É:
mongodb://192.168.1.70:27017/?replicaSet=rs0

–≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã Docker, Compass –∏ gRPC-–∫–ª–∏–µ–Ω—Ç—ã –≤–∏–¥–µ–ª–∏ –æ–¥–Ω—É –∏ —Ç—É –∂–µ MongoDB

Redis, NATS –∏ gRPC —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π




